# TODO

- [x] Link locations on map to locations in selection list
  - if location selected on map, select the same location in list
  - if location selected in list, highlight the same location on map
- [x] If location with responses is selected, show responses in detail view (can we show it in leaflet popup?)
  - âœ… EXPERIMENTAL IMPLEMENTATION COMPLETED - See `feature/popup-responses` branch (commit 65ff57c)
  - Full ResponseCard component with compact layout for popups
  - Navigation controls for multiple responses per location
  - Complete i18n translations and comprehensive F017 documentation
  - Status: ON HOLD - UX feasibility needs evaluation, compact popup design may not be optimal
  - Alternative approaches to consider: modal overlay, sidebar integration, or expandable popup views
- [x] Find all places, where we are checking for ._id but actually should only look for .reference (e.g. in useTaskDetail.ts)
- [x] find out, why was expanding options after headers in callApi critical for POST requests - was it just a timing issue or something else?
- [x] remove the certs from the repo!
- [x] could we use typescript interfaces to define the shape of Entu entities (e.g. Task, Response, Location) and use them across the app for better type safety and autocompletion?
  - âœ… **COMPLETED IN F022** - See `feature/F022-entu-entity-types` branch
  - **ACHIEVEMENT**: ðŸŽ‰ **100% COMPOSABLE TYPE COVERAGE** (9/9 composables migrated!)
  - Created comprehensive type system in `types/entu.ts` with base types, entity interfaces, and type guards
  - Added utility helpers in `utils/entu-helpers.ts` for type-safe value extraction
  - Migrated ALL JavaScript composables to TypeScript (~2,089 JS â†’ ~2,665 TS, +576 interfaces)
  - Fixed 4 critical bugs during migration (variable naming, user._id, iOS permissions, missing exports)
  - iOS GPS flow tested and working (3 Safari scenarios verified)
  - Complete documentation: `.copilot-workspace/features/F022-COMPOSABLE-MIGRATION.md`
  - **Status**: âœ… **READY TO MERGE TO MAIN** ðŸš€
- [x] **Investigate `/auth/callback` redirect behavior** âœ… **COMPLETED IN F025**
  - **Status**: Callback page optimized for instant redirect during F025 implementation
  - **Implementation**:
    - âœ… Minimal UI: spinner + "Suunatakse Ã¼mber..." text only
    - âœ… NO debug info shown (OAuth details, tokens, etc. removed)
    - âœ… Instant redirect using `onMounted()` (no artificial delays)
    - âœ… Defensive fallback link (user-approved for edge cases)
    - âœ… Clean i18n translations (et, en, uk)
  - **Result**: Page visible for <100ms, professional UX
- [x] **Fix expired token handling on browser tab restore** âœ… **COMPLETED IN F025**
  - **Feature**: F025 - Expired Token Handling (October 5-6, 2025)
  - **Implementation completed**:
    - âœ… Proactive token validation in `auth.ts` middleware (checks BEFORE route loads)
    - âœ… 60-second buffer prevents mid-request expiry
    - âœ… Automatic redirect to `/login` with return URL preservation
    - âœ… User-friendly i18n notifications (Estonian, English, Ukrainian)
    - âœ… Smart error handling: distinguishes auth errors (redirect) from network errors (retry button)
    - âœ… Naive UI notification integration with discrete API
    - âœ… Auth callback instant redirect (<100ms, minimal UI flash)
  - **Token validation utilities**:
    - `app/utils/token-validation.ts` - JWT decoder with 60s buffer
    - `app/utils/error-handling.ts` - Smart error analyzer
  - **Bugs discovered and fixed during testing**:
    - Bug #1: 500 error with `useI18n()` in middleware â†’ Fixed: use `useNuxtApp().$i18n` (commit 1918cf0)
    - Bug #2: Redirect loop with expired token â†’ Fixed: reordered middleware checks (commit 23f8966)
    - Bug #3: Translation keys showing instead of text â†’ Fixed: type cast for $i18n.t() (commit 401ab7c)
    - Bug #4: "Already logged in" message with no valid token â†’ Fixed: use logout() composable (commit 72bcfd0)
  - **Testing infrastructure**:
    - Comprehensive testing guide: `docs/testing/F025-TESTING-GUIDE.md` (564 lines, 23 test scenarios)
    - Interactive test helper: `docs/testing/token-test-helper.html` (410 lines)
    - Console helper scripts: checkToken(), expireToken(), checkAuthStorage()
  - **Status**: âœ… **PRODUCTION READY** - Initial testing passed, awaiting team testing
- [ ] **Add long-press gesture to toggle map fullscreen mode**
  - **Feature**: F026 - Map Fullscreen Toggle (planned for October 6-7, 2025)
  - **Behavior**: User long-presses anywhere on the map â†’ map enters/exits fullscreen
  - **Implementation approach**:
    - Use `@longpress` event on InteractiveMap component (VueUse `useLongPress` or custom implementation)
    - Toggle fullscreen using Fullscreen API: `element.requestFullscreen()` / `document.exitFullscreen()`
    - Fallback for iOS Safari: Use CSS fullscreen overlay (position: fixed, z-index: 9999) since iOS doesn't support Fullscreen API
    - Add visual feedback during long-press (e.g., expanding circle animation, haptic feedback)
    - Show subtle hint/icon when entering fullscreen: "Tap to exit fullscreen" (auto-hide after 2s)
  - **UX considerations**:
    - Long-press duration: ~500-700ms (not too sensitive, prevents accidental triggers)
    - Don't trigger if user is dragging/panning the map
    - Exit fullscreen on: long-press again, ESC key, or dedicated exit button
    - Preserve map state (zoom, center, selected markers) when toggling fullscreen
  - **Technical notes**:
    - VueUse has `useFullscreen()` composable for easy implementation
    - May need to handle Leaflet map resize: `map.invalidateSize()` after fullscreen change
    - Consider mobile-specific behaviors (hide browser chrome, handle safe areas)
