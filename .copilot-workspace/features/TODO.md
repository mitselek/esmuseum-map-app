# TODO

- [x] Link locations on map to locations in selection list
  - if location selected on map, select the same location in list
  - if location selected in list, highlight the same location on map
- [x] If location with responses is selected, show responses in detail view (can we show it in leaflet popup?)
  - âœ… EXPERIMENTAL IMPLEMENTATION COMPLETED - See `feature/popup-responses` branch (commit 65ff57c)
  - Full ResponseCard component with compact layout for popups
  - Navigation controls for multiple responses per location
  - Complete i18n translations and comprehensive F017 documentation
  - Status: ON HOLD - UX feasibility needs evaluation, compact popup design may not be optimal
  - Alternative approaches to consider: modal overlay, sidebar integration, or expandable popup views
- [x] Find all places, where we are checking for ._id but actually should only look for .reference (e.g. in useTaskDetail.ts)
- [x] find out, why was expanding options after headers in callApi critical for POST requests - was it just a timing issue or something else?
- [x] remove the certs from the repo!
- [x] could we use typescript interfaces to define the shape of Entu entities (e.g. Task, Response, Location) and use them across the app for better type safety and autocompletion?
  - âœ… **COMPLETED IN F022** - See `feature/F022-entu-entity-types` branch
  - **ACHIEVEMENT**: ðŸŽ‰ **100% COMPOSABLE TYPE COVERAGE** (9/9 composables migrated!)
  - Created comprehensive type system in `types/entu.ts` with base types, entity interfaces, and type guards
  - Added utility helpers in `utils/entu-helpers.ts` for type-safe value extraction
  - Migrated ALL JavaScript composables to TypeScript (~2,089 JS â†’ ~2,665 TS, +576 interfaces)
  - Fixed 4 critical bugs during migration (variable naming, user._id, iOS permissions, missing exports)
  - iOS GPS flow tested and working (3 Safari scenarios verified)
  - Complete documentation: `.copilot-workspace/features/F022-COMPOSABLE-MIGRATION.md`
  - **Status**: âœ… **READY TO MERGE TO MAIN** ðŸš€
- [ ] **Investigate `/auth/callback` redirect behavior**
  - Currently shows debug info (OAuth callback details, auth keys, "Authentication successful!")
  - Shows "Suunamine..." (Redirecting...) but redirect appears slow/delayed
  - Should either:
    - Auto-redirect immediately after token storage (< 100ms, no visible page)
    - Remove debug info display for production
    - Add proper loading spinner/animation instead of static text
  - Consider if this debug page is necessary or if callback should be invisible to users
- [ ] **Fix expired token handling on browser tab restore**
  - **Symptom**: Browser restores tabs with URLs like `/?task=68bab85d43e4daafab199988`, app gets stuck with 401 errors
  - **Additional symptom**: On mobile (screenshot), user sees "Ãœlesanded" page with "API error: 403 Forbidden" and "Proovi uuesti" (Try again) button
  - **Current behavior**:
    - `useEntuAuth.ts:294` logs "Token expired or refresh forced - user needs to re-authenticate via OAuth"
    - `callApi` throws 401 errors: `API error: 401`
    - Mobile shows 403 Forbidden error with retry button (doesn't help - still expired token)
    - App continues loading (GPS works, map loads) but task loading fails silently
    - No automatic redirect to login page
  - **Expected behavior**:
    - Detect expired token before making API calls
    - Automatically redirect to `/login` with return URL preserved
    - Show user-friendly message: "Session expired, please log in again"
    - Don't show "Proovi uuesti" button if token is expired (it won't work)
  - **Root cause**: Token expiry check happens during API call, not during auth middleware
  - **Suggested fix**:
    - Add token expiry validation in `auth.js` middleware (check before route loads)
    - Implement automatic redirect to login with `?redirect=` query parameter
    - Add user-friendly notification using Naive UI's `useNotification()` (already installed)
    - Update error handling to distinguish between network errors (retry makes sense) vs auth errors (redirect to login)
    - Consider adding "remember me" / longer-lived refresh tokens
- [ ] **Add long-press gesture to toggle map fullscreen mode**
  - **Behavior**: User long-presses anywhere on the map â†’ map enters/exits fullscreen
  - **Implementation approach**:
    - Use `@longpress` event on InteractiveMap component (VueUse `useLongPress` or custom implementation)
    - Toggle fullscreen using Fullscreen API: `element.requestFullscreen()` / `document.exitFullscreen()`
    - Fallback for iOS Safari: Use CSS fullscreen overlay (position: fixed, z-index: 9999) since iOS doesn't support Fullscreen API
    - Add visual feedback during long-press (e.g., expanding circle animation, haptic feedback)
    - Show subtle hint/icon when entering fullscreen: "Tap to exit fullscreen" (auto-hide after 2s)
  - **UX considerations**:
    - Long-press duration: ~500-700ms (not too sensitive, prevents accidental triggers)
    - Don't trigger if user is dragging/panning the map
    - Exit fullscreen on: long-press again, ESC key, or dedicated exit button
    - Preserve map state (zoom, center, selected markers) when toggling fullscreen
  - **Technical notes**:
    - VueUse has `useFullscreen()` composable for easy implementation
    - May need to handle Leaflet map resize: `map.invalidateSize()` after fullscreen change
    - Consider mobile-specific behaviors (hide browser chrome, handle safe areas)
